# Pterodactyl Control Plane

A production-ready multi-tenant hosting control plane built on top of Pterodactyl. Enables customers ("tenants") to connect their own Linux servers and create game servers for their users through a centralized management interface.

## ðŸš€ Quick Start

### One-Line Installation (DigitalOcean Ready)

For your DigitalOcean server at `138.68.232.131` with domain `multihost.techgamingexperts.com`:

```bash
curl -fsSL https://raw.githubusercontent.com/your-org/pterodactyl-control-plane/main/bootstrap_ubuntu22.sh -o bootstrap.sh \
  && sudo bash bootstrap.sh --domain-cp multihost.techgamingexperts.com --email admin@techgamingexperts.com
```

### Prerequisites
- **Fresh Ubuntu 22.04 LTS server** with root SSH access (âœ… Your DigitalOcean droplet)
- **DNS A record** pointing to your server:
  - `multihost.techgamingexperts.com` â†’ `138.68.232.131`
- **Minimum Requirements**:
  - 20GB disk space
  - 2GB RAM (4GB+ recommended)
  - 2 CPU cores

### Installation Options
```bash
# Basic installation
sudo bash bootstrap.sh --domain-cp cp.example.com --email admin@example.com

# With custom timezone and SSH key
sudo bash bootstrap.sh \
  --domain-cp cp.example.com \
  --domain-panel panel.example.com \
  --email admin@example.com \
  --timezone "America/Los_Angeles" \
  --ssh-pubkey "ssh-ed25519 AAAA..."

# With external databases
sudo bash bootstrap.sh \
  --domain-cp cp.example.com \
  --email admin@example.com \
  --db-external "true" \
  --db-url "postgres://user:pass@host:5432/dbname" \
  --redis-external "true" \
  --redis-url "redis://host:6379"

# Skip TLS (for air-gapped environments)
sudo bash bootstrap.sh \
  --domain-cp cp.example.com \
  --email admin@example.com \
  --no-certbot
```

## Architecture

### Components
- **Control Plane API**: NestJS + Fastify backend with PostgreSQL and Redis
- **Web Portal**: Next.js 14 with dual RBAC (Global Admin + Tenant Portal)
- **Edge Agent**: Go binary running on tenant nodes for monitoring and management
- **Installer**: One-liner script for tenant node enrollment

### Security Features
- JWT access/refresh tokens with 2FA support
- Encrypted Pterodactyl API keys at rest
- mTLS communication between agents and control plane
- Per-tenant data isolation
- Comprehensive audit logging
- UFW firewall configuration

## Pterodactyl Integration

### Using External Pterodactyl Panel (Recommended)
1. Set environment variables in `.env`:
   ```env
   PTERODACTYL_URL=https://panel.example.com
   PTERODACTYL_API_KEY=your_application_api_key
   ```

### Co-hosting Pterodactyl Panel
Run the included panel installer:
```bash
sudo bash installers/install_panel.sh --domain panel.example.com --email admin@example.com
```

## Usage

### Global Admin Tasks
1. Login at `https://cp.example.com/admin`
2. Create tenants and set quotas
3. Manage egg library
4. Monitor system health

### Tenant Admin Tasks
1. Login at `https://cp.example.com/tenant`
2. Add nodes using the one-liner installer
3. Create game servers
4. Manage end users

### Adding Tenant Nodes
```bash
# Generated by control plane for each tenant
curl -fsSL https://cp.example.com/api/tenants/TENANT_ID/nodes/install | bash
```

## Development

### Local Development Setup
```bash
# Clone repository
git clone https://github.com/your-org/pterodactyl-control-plane.git
cd pterodactyl-control-plane

# Install dependencies
npm install

# Start services
docker compose -f deploy/docker-compose.dev.yml up -d

# Run development servers
npm run dev
```

### Building for Production
```bash
npm run build
docker compose -f deploy/docker-compose.yml up -d --build
```

## Operations

### Logs
```bash
# Application logs
docker logs hosting-control-plane
docker logs hosting-web-portal

# Nginx logs
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# Edge agent logs (on tenant nodes)
journalctl -u hosting-edge-agent -f
```

### Backup
```bash
# Database backup
docker exec hosting-postgres pg_dump -U postgres pterodactyl_cp > backup.sql

# Environment and configuration
cp /opt/hosting/app/.env /opt/hosting/backups/.env.$(date +%Y%m%d)

# Docker volumes
docker run --rm -v hosting_postgres_data:/data -v $(pwd):/backup ubuntu tar czf /backup/postgres_data.tar.gz /data
```

### Updates
```bash
cd /opt/hosting/app
git pull
docker compose up -d --build
```

### SSL Certificate Renewal
Certificates auto-renew via certbot. Manual renewal:
```bash
sudo certbot renew
sudo nginx -s reload
```

### Uninstall
```bash
sudo systemctl stop hosting-control-plane
sudo docker compose -f /opt/hosting/app/deploy/docker-compose.yml down -v
sudo rm -rf /opt/hosting
sudo userdel deploy
```

## Security

### Rotating Secrets
1. Generate new JWT secrets:
   ```bash
   openssl rand -hex 32
   ```
2. Update `.env` files
3. Restart services:
   ```bash
   docker compose restart
   ```

### Firewall Rules
```bash
# Check current rules
sudo ufw status

# Allow additional ports if needed
sudo ufw allow 8080/tcp comment "Custom service"
```

## Troubleshooting

### DNS Issues
Verify DNS records are pointing to your server:
```bash
nslookup cp.example.com
nslookup panel.example.com
```

### SSL Certificate Issues
Check certificate status:
```bash
sudo certbot certificates
```

### Service Health
```bash
# Check all containers
docker ps

# Check specific service
docker logs hosting-control-plane

# Check database connectivity
docker exec hosting-postgres pg_isready
```

### Edge Agent Issues
On tenant nodes:
```bash
# Check agent status
sudo systemctl status hosting-edge-agent

# View agent logs
sudo journalctl -u hosting-edge-agent -n 50

# Restart agent
sudo systemctl restart hosting-edge-agent
```

## API Documentation

API documentation is available at `https://cp.example.com/api/docs` when running.

## Support

For issues and feature requests, please use the GitHub issue tracker.

## License

MIT License - see LICENSE file for details.